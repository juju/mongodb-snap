name: juju-db
version: '7.3.4'
summary: MongoDB object/document oriented database used internally by Juju.
description: |
  MongoDB object/document oriented database used internally by Juju.
confinement: strict
grade: stable
base: core24
license: SSPL-1.0

apps:
  daemon:
    command: commands/daemon.start
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    plugs:
      - network-bind
      - network-observe
      - system-observe
      - mount-observe

  logrotate:
    command: usr/sbin/logrotate --verbose --state $SNAP_COMMON/logrotate.state $SNAP/etc/logrotate-juju-db.conf
    daemon: simple
    restart-condition: on-failure
    timer: 00:00

  mongod:
    command: bin/mongod
    plugs:
      - network
      - network-bind
      - network-observe
      - system-observe
      - mount-observe

  mongo:
    command: bin/mongo
    plugs:
      - network

  # Tools
  mongodump:
    command: bin/mongodump
    plugs:
      - network
      - home

  mongorestore:
    command: bin/mongorestore
    plugs:
      - network
      - home

  mongostat:
    command: bin/mongostat
    plugs:
      - network

  mongotop:
    command: bin/mongotop
    plugs:
      - network

parts:
  wrappers:
    plugin: dump
    source: snap/local/
    source-type: local

  mongo-tools:
    source: https://github.com/mongodb/mongo-tools
    source-type: git
    source-tag: "100.10.0"
    plugin: nil
    build-snaps:
      - go
    build-packages:
      - pkg-config
      - libssl-dev
      - libpcap0.8-dev
      - libsasl2-dev
      - libkrb5-dev
    stage-packages:
      - libssl3
      - libpcap0.8
      - libsasl2-2
    override-build: |
      export GOROOT=/snap/go/current
      export GOPATH=$(realpath ..)
      # mongo tools hard codes the build platform to bionic
      # and panics if built on anything else :-(
      # Tricking it into thinking it's running in CI
      # forces it to look at an env var for the platform.
      export CI=anything
      export EVG_VARIANT=ubuntu2404
      ./make build
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      mongo_tools="mongodump mongorestore mongotop mongostat"
      for tool in ${mongo_tools}; do
          echo "Processing ${tool}..."
          strip -s bin/$tool
          mv bin/$tool ${SNAPCRAFT_PART_INSTALL}/bin/
      done

  mongo:
    after: [mongo-tools]
    source: https://github.com/mongodb/mongo
    source-type: git
    source-tag: "r7.3.4"
    plugin: nil
    stage-packages:
      - libssl3
      - libcurl4
      - libstemmer0d
      - zlib1g
      - libsnappy1v5
      - libyaml-cpp0.8
      - to amd64:
        - libtcmalloc-minimal4t64
      - to arm64:
        - libtcmalloc-minimal4t64
      - to ppc64el:
        - libtcmalloc-minimal4t64
    build-packages:
      # isn't available on s390x, only needed on the rest anyway.
      - to amd64:
        - libgoogle-perftools-dev
      - to arm64:
        - libgoogle-perftools-dev
      - to ppc64el:
        - libgoogle-perftools-dev
      - libssl-dev
      - liblzma-dev
      - libcurl4-openssl-dev
      - python3.11
      - python3.11-venv
      - python3.11-dev
      # I think these and some of the above will be needed as staging packages too (for when its installed and being run).
      # - python-requests
      # - python-subprocess32
      # Package from deb, note scons arg above.
      - libstemmer-dev
      - zlib1g-dev
      - libsnappy-dev
      - libyaml-cpp-dev
      - libpcre2-dev
      # packages from the mongodb wiki/doc
      - build-essential
      # required packages
      - valgrind

    override-build: |
      # We need to use Python 3.11 to build.
      python3.11 -m venv _build --prompt mongo
      source _build/bin/activate
      python3 -m pip install --upgrade pip

      python3 -m pip install distlib
      # Later mongo source has a build script for poetry.
      # But for 7.x we need to do it manually.
      python3 -m pip install poetry
      export PYTHON_KEYRING_BACKEND=keyring.backends.null.Keyring
      python3 -m poetry update poetry pyproject-hooks distlib virtualenv packaging cryptography pkgutil
      python3 -m poetry install --no-root --sync

      # don't care: --server-js=off
      # Use system tcmalloc as it's more 'trusted' and would be updated by kernel/security team.
      SCONSFLAGS="--disable-warnings-as-errors --use-system-pcre2 --use-system-snappy --use-system-zlib --use-system-valgrind --use-system-stemmer --use-system-yaml --ssl"
      arch=$(uname -m)
      if [ $arch = "aarch64" ]; then
          ccflags_arg="CCFLAGS=-march=armv8-a+crc"
      else
          ccflags_arg=""
      fi

      if [ $arch = "s390x" ]; then
          SCONSFLAGS="$SCONSFLAGS --allocator=system"
      else
          SCONSFLAGS="$SCONSFLAGS --use-system-tcmalloc --allocator=tcmalloc"
      fi
      export SCONSFLAGS
      export DESTDIR=$SNAPCRAFT_PART_INSTALL

      python3 buildscripts/scons.py install-mongo install-mongod --linker=gold $ccflags_arg

      # Strip binaries down to a usable size.
      for file in $SNAPCRAFT_PART_BUILD/build/install/bin/mongo*;
          do strip -s $file;
      done
      mv $SNAPCRAFT_PART_BUILD/build/install/bin $SNAPCRAFT_PART_INSTALL/

  logrotate:
    plugin: dump
    source: logrotate
    source-type: local
    stage-packages:
      - logrotate
    override-build: |
      snapcraftctl build
      install --mode 0644 juju-db.conf ${SNAPCRAFT_PART_INSTALL}/etc/logrotate-juju-db.conf

package-repositories:
  - type: apt
    ppa: deadsnakes/ppa
